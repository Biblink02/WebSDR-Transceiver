<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSDR System Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 20px; }
        .box { border: 1px solid #444; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: #111; }
        button { cursor: pointer; padding: 10px 20px; background: #007bff; color: white; border: none; font-size: 16px; border-radius: 4px; }
        button:disabled { background: #555; }
        button.stop { background: #dc3545; }
        input { padding: 10px; font-size: 16px; background: #333; color: white; border: 1px solid #555; }
        #logs { height: 300px; overflow-y: scroll; border: 1px solid #333; padding: 10px; background: black; opacity: 0.9; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .data-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #333; margin-right: 5px; }
        .active { background: #0f0; box-shadow: 0 0 5px #0f0; }
    </style>
</head>
<body>

    <h1>ðŸ“¡ WebSDR System Test</h1>

    <div class="box">
        <h3>1. Status</h3>
        <p>Socket ID: <span id="socketId" style="color: yellow">Disconnected</span></p>
        <p>Worker: <span id="workerStatus">None</span></p>
        <p>Audio Rate: <span id="audioRate">0</span> packets/sec <span class="data-indicator" id="audioLed"></span></p>
    </div>

    <div class="box">
        <h3>2. Controls</h3>
        <div>
            <label>Frequency (Hz): </label>
            <input type="number" id="freq" value="433000000">
            <button onclick="requestWorker()">â–¶ Start Audio</button>
            <button onclick="tune()">âš¡ Tune</button>
            <button onclick="stopWorker()" class="stop">â–  Stop</button>
        </div>
    </div>

    <div class="box">
        <h3>3. Logs (Check F12 Console for details)</h3>
        <div id="logs"></div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const socket = io(); // Si connette automaticamente allo stesso host
        let audioContext = null;
        let nextStartTime = 0;
        let packetCount = 0;

        // --- GESTIONE LOG ---
        function log(msg, type = 'info') {
            const div = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.color = type === 'err' ? 'red' : (type === 'data' ? '#aaa' : '#0f0');
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            div.prepend(entry);
            // Loggare in console permette di ispezionare gli oggetti
            console.log(msg);
        }

        // --- GESTIONE SOCKET.IO ---
        socket.on('connect', () => {
            document.getElementById('socketId').innerText = socket.id;
            log(`Connected to Backend. ID: ${socket.id}`);
        });

        socket.on('disconnect', () => {
            document.getElementById('socketId').innerText = "Disconnected";
            log("Disconnected form Backend", 'err');
        });

        socket.on('worker_assigned', (data) => {
            document.getElementById('workerStatus').innerText = `Assigned to ${data.worker} @ ${data.freq}Hz`;
            log(`Worker Assigned! Name: ${data.worker}`, 'info');
            initAudio(); // Prepara l'audio browser
        });

        socket.on('worker_released', () => {
            document.getElementById('workerStatus').innerText = "None";
            log("Worker Released.");
        });

        socket.on('server_full', () => {
            log("Server Full! No workers available.", 'err');
        });

        // --- RICEZIONE AUDIO (RAW PCM FLOAT32) ---
        socket.on('audio_data', (arrayBuffer) => {
            packetCount++;
            blinkLed();

            // 1. Logga il tipo di dato (per debug)
            // console.log("Audio Packet:", arrayBuffer);

            // 2. Riproduzione Audio (Semplificata per test)
            if (audioContext && arrayBuffer.byteLength > 0) {
                try {
                    // Convertiamo i bytes grezzi in Float32
                    const float32Data = new Float32Array(arrayBuffer);

                    // Creiamo un buffer audio per il browser
                    const audioBuffer = audioContext.createBuffer(1, float32Data.length, 48000);
                    audioBuffer.getChannelData(0).set(float32Data);

                    // Scheduliamo la riproduzione
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioContext.destination);

                    // Logica semplice per evitare sovrapposizioni
                    if (nextStartTime < audioContext.currentTime) {
                        nextStartTime = audioContext.currentTime;
                    }
                    source.start(nextStartTime);
                    nextStartTime += audioBuffer.duration;
                } catch (e) {
                    console.error("Audio Decode Error:", e);
                }
            }
        });

        // --- RICEZIONE GRAFICA (FFT) ---
        socket.on('graphics_data', (data) => {
            // Arriva come ArrayBuffer o Blob
            // console.log("Graphics Packet size:", data.byteLength);
        });

        // --- COMANDI UTENTE ---
        function requestWorker() {
            const freq = parseFloat(document.getElementById('freq').value);
            log(`Requesting worker at ${freq} Hz...`);
            socket.emit('request_audio_worker', { freq: freq, bw: 15000 });

            // Necessario per sbloccare l'audio nei browser moderni
            if(!audioContext) initAudio();
        }

        function stopWorker() {
            log("Releasing worker...");
            socket.emit('release_audio_worker');
        }

        function tune() {
            const freq = parseFloat(document.getElementById('freq').value);
            log(`Tuning to ${freq} Hz...`);
            socket.emit('tune', { freq: freq, bw: 15000 });
        }

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({sampleRate: 48000});
                log("AudioContext Initialized (48kHz)");
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // --- UTILS ---
        function blinkLed() {
            const led = document.getElementById('audioLed');
            led.classList.add('active');
            setTimeout(() => led.classList.remove('active'), 50);
        }

        // Calcolo rate pacchetti
        setInterval(() => {
            document.getElementById('audioRate').innerText = packetCount;
            packetCount = 0;
        }, 1000);

    </script>
</body>
</html>